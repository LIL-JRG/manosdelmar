---
import { useEffect, useState } from "react";

type CartItem = {
  title: string;
  creator: string;
  image: string;
  quantity: number;
};
---

<section class="min-h-screen bg-[#fef9f3] text-[#3b2e2a] px-4 py-20">
  <h1 class="text-3xl font-bold text-center mb-10">Carrito de productos</h1>
  <div id="cart-app" class="max-w-4xl mx-auto space-y-6"></div>

  <script type="module" is:inline>
    const cartContainer = document.getElementById("cart-app");

    function getCart() {
      return JSON.parse(localStorage.getItem("cart") || "[]");
    }

    function setCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function renderCart() {
      const cart = getCart();

      if (!cart.length) {
        cartContainer.innerHTML =
          "<p class='text-center text-[#6b4d42]'>Tu carrito está vacío.</p>";
        return;
      }

      const itemsHTML = cart
        .map(
          (item, index) => `
        <div class="bg-white rounded-xl shadow-md p-4 flex gap-4 items-center group">
          <img src="${item.image}" alt="${item.title}" class="w-24 h-24 object-cover rounded-lg border border-[#e6d5c9]" />
          <div class="flex-1">
            <h3 class="text-lg font-semibold">${item.title}</h3>
            <p class="text-sm text-[#7a5e4f] mb-2">Artesana: ${item.creator}</p>
            <div class="flex items-center gap-2">
              <button data-action="decrease" data-index="${index}" class="px-3 py-1 rounded bg-[#a1583c] text-white hover:bg-[#8d422c] transition">-</button>
              <span class="min-w-[20px] text-center">${item.quantity}</span>
              <button data-action="increase" data-index="${index}" class="px-3 py-1 rounded bg-[#a1583c] text-white hover:bg-[#8d422c] transition">+</button>
            </div>
          </div>
          <button data-action="remove" data-index="${index}" class="text-red-500 font-bold text-2xl hover:scale-110 transition">✕</button>
        </div>
      `,
        )
        .join("");
      // Agregar el Número de WhatsApp 
      const whatsappLink = `https://wa.me/52?text=${encodeURIComponent(
        `¡Hola! Me gustaría cotizar los siguientes productos:\n\n` +
          cart
            .map(
              (item, index) =>
                `${index + 1}. *${item.title}*\n   Cantidad: ${item.quantity}\n   Artesana: ${item.creator}`,
            )
            .join("\n\n") +
          `\n\n¿Me podrías apoyar con la información de precios y tiempos de entrega? Muchas gracias.`,
      )}`;

      cartContainer.innerHTML = `
        <div class="space-y-6">${itemsHTML}</div>
        <div class="text-center mt-10">
          <a href="${whatsappLink}" target="_blank" class="inline-block bg-[#a1583c] text-white px-8 py-3 rounded-lg shadow-md hover:bg-[#8d422c] transition-all">
            Cotizar por WhatsApp
          </a>
        </div>
      `;

      attachButtonEvents();
    }

    function attachButtonEvents() {
      cartContainer
        .querySelectorAll("button[data-action]")
        .forEach((button) => {
          const action = button.dataset.action;
          const index = parseInt(button.dataset.index);

          button.addEventListener("click", () => {
            const cart = getCart();

            if (action === "increase") {
              cart[index].quantity += 1;
            } else if (action === "decrease") {
              cart[index].quantity = Math.max(1, cart[index].quantity - 1);
            } else if (action === "remove") {
              cart.splice(index, 1);
            }

            setCart(cart);
            renderCart();
          });
        });
    }
    
    // Inicializar el carrito al cargar la página
    renderCart();
  </script>
</section>
